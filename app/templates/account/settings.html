{% extends "dashboard.html" %}
{% block title %}
Settings
{% endblock %}

{% block page_content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.1.1/flowbite.min.css" rel="stylesheet" />
<h1 class="text-3xl text-black pb-6">Settings</h1>

<h2 class="text-2xl text-black pb-6">General Information</h2>
<div class="bg-white px-4 pt-5 pb-4 mb-10 sm:p-6 rounded-lg sm:pb-4">
	<form id="userUpdateForm" class="space-y-4">
		<div>
			<label for="firstName" class="block text-lg font-medium text-gray-700">First Name</label>
			<input type="text" id="firstName" name="firstName" required
							  class="mt-1 p-2 block w-full border rounded-md shadow-sm focus:outline-none focus:border-blue-500">
		</div>
		<div>
			<label for="middleName" class="block text-lg font-medium text-gray-700">Middle Name</label>
			<input type="text" id="middleName" name="middleName" required
							   class="mt-1 p-2 block w-full border rounded-md shadow-sm focus:outline-none focus:border-blue-500">
		</div>
		<div>
			<label for="lastName" class="block text-lg font-medium text-gray-700">Last Name</label>
			<input type="text" id="lastName" name="lastName" required
							 class="mt-1 p-2 block w-full border rounded-md shadow-sm focus:outline-none focus:border-blue-500">
		</div>
		<div>
			<label for="gender" class="block text-lg font-medium text-gray-700">Gender</label>
			<select id="gender" name="gender"
					    class="mt-1 p-2 block w-full border rounded-md shadow-sm focus:outline-none focus:border-blue-500">
				<option value="male">Male</option>
				<option value="female">Female</option>
			</select>
		</div>
		<div>
			<label for="phoneNumber" class="block text-lg font-medium text-gray-700">Phone Number</label>
			<input type="text" id="phoneNumber" name="phoneNumber" required
							    class="mt-1 p-2 block w-full border rounded-md shadow-sm focus:outline-none focus:border-blue-500">
		</div>
		<div>
			<label for="emailAddress" class="block text-lg font-medium text-gray-700">Email Address</label>
			<input type="email" id="emailAddress" name="emailAddress" required
							      class="mt-1 p-2 block w-full border rounded-md shadow-sm focus:outline-none focus:border-blue-500">
		</div>
		<div>
			<label for="nationality" class="block text-lg font-medium text-gray-700">Nationality</label>
			<select id="nationality" name="nationality"
						 class="mt-1 p-2 block w-full border rounded-md shadow-sm focus:outline-none focus:border-blue-500">
				<!-- Populated dynamically using JavaScript -->
			</select>
		</div>

		<!-- Alert messages for success and error -->
		<div id="errorAlert"
		     class="mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded-md hidden">
			<!-- Error messages will appear here -->
		</div>
		<div id="successAlert"
		     class="mt-4 bg-green-100 border border-green-400 text-green-700 px-4 py-2 rounded-md hidden">
			<!-- Success messages will appear here -->
		</div>

		<!-- Modal footer -->
		<div class="mt-5 sm:mt-6">
			<button type="submit"
				class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 focus:outline-none focus:shadow-outline-blue active:bg-blue-800">
				Save Update
			</button>
		</div>
	</form>
</div>

<h2 class="text-2xl text-black mt-4 pb-6">Update Profile Picture</h2>
<div class="bg-white px-4 pt-5 pb-4 mb-10 sm:p-6 rounded-lg sm:pb-4">
	<form id="uploadForm" enctype="multipart/form-data">
		<label class="block mb-2 text-lg font-medium text-gray-900 dark:text-white" for="file">Select an Image</label>
		<input id="file" type="file" accept="image/*" name = "file" class="block w-full text-md text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400" aria-describedby="file_input_help" >
		<p class="mt-1 text-md text-gray-500 dark:text-gray-300" id="file_input_help">SVG, PNG, JPG or GIF (MAX. 800x400px).</p>

		<div>
			<button type="submit" id = "uploadBtn"
				class="bg-blue-500 text-white px-4 py-2 mt-6 rounded-md hover:bg-blue-600 focus:outline-none focus:shadow-outline-blue active:bg-blue-800">
				Save Update
			</button>
		</div>
	</form>
</div>

<h2 class="text-2xl text-black mt-4 pb-6">Update Password</h2>
<div class="bg-white px-4 pt-5 pb-4 mb-10 sm:p-6 rounded-lg sm:pb-4">
	<form id="passwordResetForm">
		<div id="errorMessage" class="text-red-500 mb-4"></div>
		<div id="successMessage" class="text-green-500 mb-4"></div>

		<label for="oldPassword" class="block text-lg font-medium text-gray-700">Old Password</label>
		<input type="password" id="oldPassword" required
				       class="mt-1 p-2 w-full border rounded-md focus:outline-none focus:border-blue-500">

		<label for="newPassword" class="block mt-4 text-lg font-medium text-gray-700">New Password</label>
		<input type="password" id="newPassword" required
				       class="mt-1 p-2 w-full border rounded-md focus:outline-none focus:border-blue-500">

		<label for="confirmPassword" class="block mt-4 text-lg font-medium text-gray-700">Confirm Password</label>
		<input type="password" id="confirmPassword" required
				       class="mt-1 p-2 w-full border rounded-md focus:outline-none focus:border-blue-500">

		<button type="button"
			class="bg-blue-500 text-white px-4 py-2 mt-4 rounded-md hover:bg-blue-600 focus:outline-none focus:shadow-outline-blue active:bg-blue-800">
			Reset Password
		</button>
	</form>
</div>

<h2 class="text-2xl text-black mt-4 pb-6">Update Email Address</h2>
<div class="bg-white px-4 pt-5 pb-4 mb-10 sm:p-6 rounded-lg sm:pb-4">
	<form id="emailAddressResetForm">
		<div id="errorMessage" class="text-red-500 mb-4"></div>
		<div id="successMessage" class="text-green-500 mb-4"></div>

		<label for="oldEmailAddress" class="block text-lg font-medium text-gray-700">Old Email Address</label>
		<input type="emailAddress" id="oldEmailAddress" required
					   class="mt-1 p-2 w-full border rounded-md focus:outline-none focus:border-blue-500">

		<label for="newEmailAddress" class="block mt-4 text-lg font-medium text-gray-700">New Email Address</label>
		<input type="emailAddress" id="newEmailAddress" required
					   class="mt-1 p-2 w-full border rounded-md focus:outline-none focus:border-blue-500">

		<label for="confirmEmailAddress" class="block mt-4 text-lg font-medium text-gray-700">Confirm Email Address</label>
		<input type="emailAddress" id="confirmEmailAddress" required
					   class="mt-1 p-2 w-full border rounded-md focus:outline-none focus:border-blue-500">

		<button type="button"
			class="bg-blue-500 text-white px-4 py-2 mt-4 rounded-md hover:bg-blue-600 focus:outline-none focus:shadow-outline-blue active:bg-blue-800">
			Reset EmailAddress
		</button>
	</form>
</div>

<h2 class="text-2xl text-black mt-4 pb-6">Update Phone Number</h2>
<div class="bg-white px-4 pt-5 pb-4 mb-10 sm:p-6 rounded-lg sm:pb-4">
	<form id="phoneNumberResetForm">
		<div id="errorMessage" class="text-red-500 mb-4"></div>
		<div id="successMessage" class="text-green-500 mb-4"></div>

		<label for="oldPhoneNumber" class="block text-lg font-medium text-gray-700">Old Phone Number</label>
		<input type="phoneNumber" id="oldPhoneNumber" required
					  class="mt-1 p-2 w-full border rounded-md focus:outline-none focus:border-blue-500">

		<label for="newPhoneNumber" class="block mt-4 text-lg font-medium text-gray-700">New Phone Number</label>
		<input type="phoneNumber" id="newPhoneNumber" required
					  class="mt-1 p-2 w-full border rounded-md focus:outline-none focus:border-blue-500">

		<label for="confirmPhoneNumber" class="block mt-4 text-lg font-medium text-gray-700">Confirm Phone Number</label>
		<input type="phoneNumber" id="confirmPhoneNumber" required
					  class="mt-1 p-2 w-full border rounded-md focus:outline-none focus:border-blue-500">

		<button type="button"
			class="bg-blue-500 text-white px-4 py-2 mt-4 rounded-md hover:bg-blue-600 focus:outline-none focus:shadow-outline-blue active:bg-blue-800">
			Reset PhoneNumber
		</button>
	</form>
</div>
<!-- Fetch API Script -->
<script>
	document.addEventListener('DOMContentLoaded', function () {
			const userUpdateForm = document.getElementById('userUpdateForm');
			const errorAlert = document.getElementById('errorAlert');
			const successAlert = document.getElementById('successAlert');

			function displayAlert(alertElement, message, isError) {
					alertElement.textContent = message;
					alertElement.classList.remove('hidden');
					alertElement.classList.toggle('bg-red-100', isError);
					alertElement.classList.toggle('bg-green-100', !isError);

					setTimeout(function () {
							alertElement.classList.add('hidden');
						}, 5000); // Hide the alert after 5 seconds
				}

			nationality = document.getElementById("nationality");
			// Fetch list of countries
			fetch('https://restcountries.com/v3.1/all')
				.then(response => response.json())
				.then(countries => {
						countries.sort((a, b) => a.name.common.localeCompare(b.name.common));
						// Populate nationality dropdown
						countries.forEach(country => {
								const option = document.createElement('option');
								option.value = country.name.common;
								option.text = country.name.common;
								nationality.add(option);
							});
					})
				.catch(error => {
						console.error('Error fetching countries:', error);
					});

			// Fetch user details (Replace with your actual API endpoint)
			api_server = "{{ api_server }}";
			fetch(`${api_server}api/administration/users/1`)
				.then(response => response.json())
				.then(user => {
						// Populate form fields with current user details
						document.getElementById('firstName').value = user.firstName;
						document.getElementById('middleName').value = user.middleName;
						document.getElementById('lastName').value = user.lastName;
						document.getElementById('gender').value = user.gender;
						document.getElementById('phoneNumber').value = user.phoneNumber;
						document.getElementById('emailAddress').value = user.emailAddress;
						document.getElementById('nationality').value = user.nationality;
					})
				.catch(error => {
						console.error('Error fetching user details:', error);
						displayAlert(errorAlert, 'Failed to fetch user details. Please try again.', true);
					});


			userUpdateForm.addEventListener('submit', function (event) {
					event.preventDefault();
					const apiUrl = `${api_server}api/administration/users/1`;
					const formData = new FormData(userUpdateForm);
					const data = {
							firstName: formData.get('firstName'),
							middleName: formData.get('middleName'),
							lastName: formData.get('lastName'),
							gender: formData.get('gender'),
							phoneNumber: formData.get('phoneNumber'),
							emailAddress: formData.get('emailAddress'),
							nationality: formData.get('nationality'),
						};

					// Make a fetch request to update user details
					fetch(apiUrl, {
							method: 'PUT',
							headers: {
									'Content-Type': 'application/json',
									'Authorization': 'Bearer ' + localStorage.getItem('jwt_token'),
								},
							body: JSON.stringify(data),
						})
						.then(response => {
								if (!response.ok) {
										throw new Error(`HTTP error! Status: ${response.status}`);
									}
								return response.json();
							})
						.then(responseData => {
								// Handle successful update
								displayAlert(successAlert, 'User updated successfully', false);
								// You can perform additional actions if needed
							})
						.catch(error => {
								// Handle update errors
								console.error('Error during user update:', error);
								displayAlert(errorAlert, 'User update failed. Please check your information and try again.', true);
							});
				});
		});
</script>
{% endblock %}
